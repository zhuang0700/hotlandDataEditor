{% extends "base.html" %}

{% macro header(src) %}
    {% if src == "toutiao" %}
        <td>广告主</td>
        <td>Title</td>
        <td style="width:278px">LandingPage</td>
        <td style="width:483px">素材</td>
        <td>pv</td>
        <td>亿米客户</td>
    {% endif %}
{% endmacro %}

{% macro render_data(src, row) %}
    {% if src == "toutiao" %}
        <td>{{ row[0] }}</td>
        <td>{{ row[1] }}</td>
        <td><a href="{{ row[2] }}" target="_blank">
            {% if row[2]|length <= 40 %}
                {{ row[2] }}
            {% else %}
                {{ row[2][:35] }}...
            {% endif %}
        </a></td>
        <td>
            {% for asset in row[3] %}
                <a href="{{ asset['url'] }}" target="_blank"><img src="{{ asset['url'] }}" width="150"></a>&nbsp;
            {% endfor %}
        </td>
        <td>{{ row[4] }}</td>
        <td>
            {% for c in row[5] %}
                <a href="/customer/history/{{ c }}">{{ c }}</a><br/>
            {% endfor %}
        </td>
    {% endif %}
{% endmacro %}

{% block page_content %}
    {% if welcome %}
        <div class="panel panel-default">
            <div class="panel-heading">Welcome</div>
            <div class="panel-body">
                <p>Welcome to Demand inSight Platform</p>
                <p>Powered By EMI-Cube</p>
            </div>
        </div>
    {% else %}
        <div class="panel panel-default">
            <!-- Default panel contents -->
            <div class="panel-heading">
                <h4>Ad Id: <span id="adIdTxt">{{ ad_id }}</span></h4>
                <input type="text" class="form-control" style="width:170px;display:inline" placeholder="Another Ad" id="adIdInput"/>
                <span class="input-group-btn" style="display:inline">
                    <button class="btn btn-info" type="button" id="adIdBtn">Go!</button>
                </span>
		&nbsp;&nbsp;
                <span class="input-group-btn" style="display:inline">
                    <button class="btn btn-info" type="button" id="dataRefreshBtn">更新Cache数据</button>
                </span>

                <br/>
                <div class="btn-group" role="group" aria-label="...">
                    <button type="button" class="btn btn-default">x坐标范围</button>
                    {% for x in maxxs %}
                        <button type="button" class="btn btn-default maxx">{{ x }}</button>
                    {% endfor %}
                </div>
            </div>
            <div class="panel panel-info">
                <div class="panel-heading">(x%,y)表示, 必须提价x%, 才能获得的点击增量和相应成本增量</div>
                <div class="container-fluid">
                    <div class="row-fluid">
                        <div id="main-chart1" style="width:100%;height:400px;"></div>
                    </div>
                </div>
            </div>
            <div class="panel panel-info">
                <div class="panel-heading">(x%,y)表示, 提价x%之后, 能获得的点击增量和相应成本增量</div>
                <div class="container-fluid">
                    <div class="row-fluid">
                        <div id="main-chart2" style="width:100%;height:400px;"></div>
                    </div>
                </div>
            </div>

            <div class="panel-heading">
                <h4>Tag Id: <span id="tagIdTxt">{{ tag_id }}</span></h4>
                <input type="text" class="form-control" style="width:170px;display:inline" placeholder="Another Ad" id="tagIdInput"/>
                <span class="input-group-btn" style="display:inline">
                    <button class="btn btn-info" type="button" id="tagIdBtn">Go!</button>
                </span>
		&nbsp;&nbsp;
                <span class="input-group-btn" style="display:inline">
                    <button class="btn btn-info" type="button" id="dataRefreshBtn">更新Cache数据</button>
                </span>
                <br/>
                <div class="btn-group" role="group" aria-label="...">
                    <button type="button" class="btn btn-default">x坐标范围</button>
                    {% for x in maxxs %}
                        <button type="button" class="btn btn-default maxx">{{ x }}</button>
                    {% endfor %}
                </div>
            </div>
            <div class="panel panel-info">
                <div class="panel-heading">tagid对应的ecpm分布图</div>
                <div class="container-fluid">
                    <div class="row-fluid">
                        <div id="main-chart3" style="width:100%;height:400px;"></div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='echarts.min.js') }}"></script>
    <script src="{{ url_for('static', filename='theme/macarons.js') }}"></script>
    <script src="{{ url_for('static', filename='theme/shine.js') }}"></script>
    <script src="{{ url_for('static', filename='theme/vintage.js') }}"></script>
    <script src="{{ url_for('static', filename='theme/roma.js') }}"></script>
    <script type="text/javascript">
        function chartIt(chart, data) {
            var xAxis = [];
            var yAxisInvest = [];
            var yAxisClick = [];
	    var yAxisFlow = [];
            for (var i in data) {
                xAxis.push(data[i].incr);
                yAxisInvest.push(data[i].invest);
                yAxisClick.push(data[i].click);
		yAxisFlow.push(data[i].flow);
            }
            // 指定图表的配置项和数据
            var option = {
                title: {
                },
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data:['点击成本增量', '点击数增量','流量增量']
                },
                toolbox: {
                },
                xAxis: {
                    data: xAxis
                },
                yAxis: {},
                series: [
                    {
                        name: '点击成本增量',
                        type: 'line',
                        data: yAxisInvest
                    },
                    {
                        name: '点击数增量',
                        type: 'line',
                        data: yAxisClick
                    },
		    {
		    	name:'流量增量',
			type:'line',
			data:yAxisFlow
		    }
                ]
            };
            chart.setOption(option);
        }

        function title(adId) {
            $("#adIdTxt").text(adId)
        }
        function ttitle(tagId){
            $("tagIdTxt").text(tagId)
        }

        function pageRefresh() {
            var adId = $("#adIdInput").val();
            title(adId);
            $.ajax({
                type: "GET",
                dataType: "json",
                url: "/bid-landscape-data?adid=" + adId + "&maxx=" + maxx ,
                success: function (msg) {
                    if (!msg.success) {
                        return false;
                    }
                    chartIt(myChart1, msg.data1);
                    chartIt(myChart2, msg.data2);
                },
                error: function () {
                    alert("查询失败")
                }
            })
        }

        function tagRefresh() {
            var tagId = $("#tagIdInput").val();
            ttitle(tagId);
            $.ajax({
                type: "GET",
                dataType: "json",
                url: "/bid-landscape-data?tagid=" + tagId + "&maxx=" + maxx ,
                success: function (msg) {
                    if (!msg.success) {
                        return false;
                    }
                    tagInfo(myChart3, msg.data1,msg.data2);
                },
                error: function () {
                    alert("查询失败")
                }
            })
        }


        function dataRefresh() {
            $.ajax({
                type: "GET",
                dataType: "json",
                url: "/bid-landscape-refresh",
                success: function (msg) {
                    alert("更新完毕")
                }
            })
        }

        function maxxClicked() {
            var e = $(this);
            maxx = e.text();
            pageRefresh();
        }

	      function tagInfo(chart,data1,data2){
            var xAxis = [];
            var yAxisCnt = [];
            for (var i in data1) {
                xAxis.push(data1[i]);
            }
            for(var i in data2){
               yAxisCnt.push(data2[i]);
            }
            var option = {
                title:{
			               text:"tagId ecpm 分布图"
		            },
		            tooltip:{
			               trigger:"axis"
		            },
		            legend:{
			               data:['ecpm']
                },
		            toolbox:{
		            },
		            xAxis:{},
		            yAxis:{},
		            series:[
			          {
			               name:'ecpm',
			               type:'bar',
			               data:yAxisCnt
                }
		            ]

            };
            chart.setOption(option);
        }
        var myChart1 = echarts.init(document.getElementById('main-chart1'), 'shine');
        var myChart2 = echarts.init(document.getElementById('main-chart2'), 'shine');
        var myChart3 =echarts.init(document.getElementById('main-chart3'),'shine');
        var maxx = "";
        $("#adIdBtn").click(pageRefresh);
        $("#tagIdBtn").click(tagRefresh);
        $("#dataRefreshBtn").click(dataRefresh);
        $(".maxx").click(maxxClicked)
    </script>
{% endblock %}
